# ========================
# URL pārakstīšana (Routing)
# ========================
RewriteEngine On

# Novirzīt uz index.php, ja fails vai mape nav atrasti
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/(uploads|assets)/
RewriteRule ^(.*)$ index.php [QSA,L]

# Draudzīgi URL
RewriteRule ^task/([0-9]+)/?$ task_details.php?id=$1 [QSA,L]
RewriteRule ^problem/([0-9]+)/?$ problem_details.php?id=$1 [QSA,L]
RewriteRule ^user/([0-9]+)/?$ user_profile.php?id=$1 [QSA,L]

# API maršruti
RewriteRule ^api/(.*)$ api/index.php?route=$1 [QSA,L]

# ========================
# Kļūdu lapas
# ========================
ErrorDocument 404 /mehi/error_404.php
ErrorDocument 403 /mehierror_403.php
ErrorDocument 500 /mehi/error_500.php

# ========================
# Drošības galvenes
# ========================
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
</IfModule>

# Kompresija
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain text/html text/xml text/css text/javascript application/javascript application/x-javascript
</IfModule>

<Files "database.sql">
    Deny from all
</Files>

# Aizliegt piekļuvi cron failiem no web
RewriteRule ^cron_scheduler\.php$ - [R=404,L]

# ========================
# Kešošana
# ========================
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType text/css "access plus 1 week"
    ExpiresByType application/javascript "access plus 1 week"
    ExpiresByType application/x-javascript "access plus 1 week"
    ExpiresByType text/html "access plus 1 hour"
</IfModule>

# ========================
# MIME tipi
# ========================
<IfModule mod_mime.c>
    AddType application/javascript .js
    AddType text/css .css
    AddType application/json .json
    AddType font/ttf .ttf
    AddType font/woff .woff
    AddType font/woff2 .woff2
</IfModule>

# ========================
# Failu piekļuves ierobežojumi
# ========================
<FilesMatch "\.(env|sql|log|ini|bak|backup|old|tmp|temp)$">
    Order allow,deny
    Deny from all
</FilesMatch>

<Files config.php>
    Deny from all
</Files>

# ========================
# Novērst SQL Injection un ļaunprātīgus pieprasījumus
# ========================
<IfModule mod_rewrite.c>
    RewriteCond %{QUERY_STRING} (\.\./|\.\.) [NC,OR]
    RewriteCond %{QUERY_STRING} (union|select|insert|drop|create|delete|update|http\:|https\:) [NC]
    RewriteRule .* - [F,L]
</IfModule>
